name: Build OpenWrt

on:
  workflow_dispatch:  # 手动触发
  push:  # 推送代码时触发（可选）
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest  # 使用最新版 Ubuntu 环境

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex g++ gawk gcc-multilib gettext git libncurses-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev

    - name: Clone OpenWrt source
      run: |
        git clone https://git.openwrt.org/openwrt/openwrt.git
        cd openwrt
        git checkout v23.05.3  # 使用官方稳定版本号

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure OpenWrt
      run: |
        cd openwrt
        make defconfig
        # 自定义配置（可选，需提前生成 .config 文件）
        # curl -O https://example.com/your-config.txt
        # cp your-config.txt .config

    - name: Build OpenWrt
      run: |
        cd openwrt
        make -j$(nproc)  # 使用所有可用核心编译
        # 或指定单线程编译（避免 GitHub 环境资源限制）
        # make -j1 V=s
